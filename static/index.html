<!-- static/index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŒŒì£¼ì‹œ ëŒë´„ì˜¨ ìŒì„± ì±—ë´‡ (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 100%;
      max-width: 480px;
      margin: 24px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      padding: 16px 16px 24px;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    h1 span.icon {
      font-size: 22px;
    }

    /* ğŸ‘‡ ì¶”ê°€ë¨: ë¡œê³  ìë™ ë°˜ì‘í˜• */
    .logo-box {
      text-align: center;
      margin: 10px 0 16px;
    }
    .logo-box img {
      width: 100%;
      max-width: 220px;
      height: auto;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 12px;
    }
    #chat {
      height: 320px;
      overflow-y: auto;
      padding: 8px;
      border-radius: 10px;
      background: #f9fafb;
      font-size: 14px;
      border: 1px solid #edf0f4;
      box-sizing: border-box;
    }
    .msg {
      margin-bottom: 8px;
      line-height: 1.5;
    }
    .user {
      text-align: right;
      color: #222;
    }
    .bot {
      text-align: left;
      color: #0b4f6c;
    }
    .label {
      font-size: 11px;
      color: #999;
      margin-bottom: 2px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 14px;
      gap: 10px;
    }
    #recordBtn {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: none;
      background: #ff6b6b;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(255,107,107,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    #recordBtn.recording {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.3);
      transform: scale(1.05);
    }
    #status {
      font-size: 13px;
      color: #555;
      min-height: 18px;
    }
    audio {
      width: 100%;
      margin-top: 4px;
    }
    .footer {
      margin-top: 10px;
      font-size: 10px;
      color: #999;
      text-align: center;
      line-height: 1.4;
    }
  </style>
</head>
<body>
<div class="container">
    <!-- ğŸ‘‡ ì—¬ê¸° ì¶”ê°€ë¨ (ë¡œê³  ì‚½ì…) -->
  <div class="logo-box">
    <img src="/static/img/pajulogo.png" alt="íŒŒì£¼ ë¡œê³ " />
  </div>

  <h1><span class="icon">ğŸŸ¢</span>íŒŒì£¼ì‹œ ëŒë´„ì˜¨ ìŒì„± ìƒë‹´</h1>


  <div class="subtitle">
    ë§í•˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ì§ˆë¬¸í•˜ì‹œë©´,<br/>
    ìŒì„±ì„ ì¸ì‹í•´ íŒŒì£¼ì‹œ ì•ˆë‚´ë¥¼ ì½ì–´ë“œë¦½ë‹ˆë‹¤.
  </div>

  <div id="chat"></div>

  <div class="controls">
    <button id="recordBtn">ë§í•˜ê¸°</button>
    <div id="status"></div>
    <audio id="answerAudio" controls></audio>
  </div>

<div class="footer" style="text-align: left;">
    â— í…ŒìŠ¤íŠ¸ìš© MVP ë²„ì „ì…ë‹ˆë‹¤.<br/>
    â— ğŸ“¢ 3ì´ˆ~6ì´ˆ ì •ë„, ë˜ë°•ë˜ë°• í•œ ë¬¸ì¥ì”© ë§ì”€í•´ ì£¼ì„¸ìš”.<br/>
    â— ì¸ì‹ì´ ì˜ ì•ˆ ë˜ë©´ ë˜ë°•ë˜ë°• ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì„¸ìš”.<br/>
</div>
</div>

<script>
  const recordBtn = document.getElementById('recordBtn');
  const statusEl = document.getElementById('status');
  const chatEl = document.getElementById('chat');
  const answerAudio = document.getElementById('answerAudio');

  let mediaRecorder = null;
  let chunks = [];
  let isRecording = false;

  // ğŸ”Š ë¬´ìŒ ê°ì§€ìš© ì˜¤ë””ì˜¤ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜
  let audioContext = null;
  let analyser = null;
  let sourceNode = null;
  let silenceStart = null;

  // ğŸ”§ íŠœë‹ ê°€ëŠ¥í•œ íŒŒë¼ë¯¸í„°
  const SILENCE_THRESHOLD = 0.02;   // ì´ ê°’ë³´ë‹¤ ì‘ìœ¼ë©´ "ì¡°ìš©"í•˜ë‹¤ê³  íŒë‹¨ (0.01~0.05 ì‚¬ì´ë¡œ ì¡°ì ˆ)
  const SILENCE_DURATION = 2000;    // ë¬´ìŒì´ ëª‡ ms ì§€ì†ë˜ë©´ stop í• ì§€ (í˜„ì¬ 2ì´ˆ)

  function addMessage(role, text) {
    const div = document.createElement('div');
    div.classList.add('msg');
    if (role === 'user') {
      div.classList.add('user');
      div.innerHTML = '<div class="label">ğŸ‘¤ ì‹œë¯¼</div>' + text;
    } else {
      div.classList.add('bot');
      div.innerHTML = '<div class="label">ğŸ¤– ëŒë´„ì˜¨</div>' + text;
    }
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // ğŸ” ë¬´ìŒ ê°ì§€ ë£¨í”„
  function startSilenceDetection() {
    if (!analyser) return;

    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);

    function detect() {
      if (!isRecording) return; // ë…¹ìŒ ëë‚˜ë©´ ë£¨í”„ ì¤‘ë‹¨

      analyser.getByteTimeDomainData(dataArray);

      // RMS(í‰ê·  ì—ë„ˆì§€) ê³„ì‚°
      let sum = 0;
      for (let i = 0; i < bufferLength; i++) {
        const v = (dataArray[i] - 128) / 128; // -1.0 ~ 1.0
        sum += v * v;
      }
      const rms = Math.sqrt(sum / bufferLength);

      // console.log('RMS:', rms);  // ë””ë²„ê·¸ìš©

      if (rms < SILENCE_THRESHOLD) {
        // ì¡°ìš©í•œ êµ¬ê°„
        if (silenceStart === null) {
          silenceStart = performance.now();
        } else {
          const elapsed = performance.now() - silenceStart;
          if (elapsed > SILENCE_DURATION && isRecording) {
            // ğŸ”” ì¼ì • ì‹œê°„ ì´ìƒ ë¬´ìŒì´ë©´ ìë™ ì¢…ë£Œ
            stopRecording();
            return;
          }
        }
      } else {
        // ë‹¤ì‹œ ë§í•˜ê¸° ì‹œì‘í•˜ë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹
        silenceStart = null;
      }

      requestAnimationFrame(detect);
    }

    requestAnimationFrame(detect);
  }

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      // ğŸ”Š AudioContext + Analyser ì„¸íŒ… (ë¬´ìŒ ê°ì§€ìš©)
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);

      // ë¬´ìŒ ê°ì§€ ì‹œì‘
      silenceStart = null;
      startSilenceDetection();

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        statusEl.textContent = 'ì§ˆë¬¸ì„ ë³´ë‚´ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

        const blob = new Blob(chunks, { type: 'audio/webm' });
        chunks = [];

        const formData = new FormData();
        formData.append('user_id', 'guest');
        formData.append('audio', blob, 'voice.webm');

        try {
          const res = await fetch('/paju/voice-chat', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();

          if (!res.ok || data.error) {
            statusEl.textContent = data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
            return;
          }

          if (data.recognized_text) {
            addMessage('user', data.recognized_text);
          }
          if (data.answer) {
            addMessage('bot', data.answer);
          }

          if (data.tts_url) {
            answerAudio.src = data.tts_url;
            answerAudio.play().catch(() => {
              // ìë™ì¬ìƒ ë§‰íˆë©´ ì‚¬ìš©ìê°€ ì§ì ‘ ì¬ìƒ
            });
          }

          statusEl.textContent = 'ë‹¤ì‹œ ë§í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';

        } catch (err) {
          console.error(err);
          statusEl.textContent = 'ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
      };

      mediaRecorder.start();
      isRecording = true;
      recordBtn.classList.add('recording');
      recordBtn.textContent = 'ë§í•˜ê¸° ì¢…ë£Œ';
      statusEl.textContent = 'ì§€ê¸ˆ ë§ì”€í•˜ì„¸ìš”... (ë§ì„ ë©ˆì¶”ë©´ ìë™ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤)';

    } catch (err) {
      console.error(err);
      statusEl.textContent = 'ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.';
    }
  }

  function stopRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordBtn.textContent = 'ë§í•˜ê¸°';
      statusEl.textContent = 'ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...';

      // ğŸ”Š ì˜¤ë””ì˜¤ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
      if (audioContext) {
        audioContext.close().catch(() => {});
        audioContext = null;
      }
      analyser = null;
      sourceNode = null;
      silenceStart = null;
    }
  }

  recordBtn.addEventListener('click', () => {
    if (!isRecording) {
      startRecording();
    } else {
      // ì‚¬ìš©ìê°€ ì§ì ‘ ëŠì–´ë„ ì •ìƒ ë™ì‘
      stopRecording();
    }
  });
</script>
</body>
</html>
